<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–∫–ª–∞–¥—Å–∫–æ–π –°–∫–∞–Ω–µ—Ä 2026</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã: Telegram API –∏ –°–∫–∞–Ω–µ—Ä -->
    <script src="https://telegram.org"></script>
    <script src="https://unpkg.com"></script>
    <style>
        :root {
            --tg-theme-bg-color: #fff;
            --tg-theme-button-color: #248bed;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-hint-color: #999;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0; padding: 20px; text-align: center;
        }
        #reader { width: 100%; max-width: 400px; margin: 0 auto; border-radius: 12px; overflow: hidden; }
        .info-card { background: rgba(0,0,0,0.05); padding: 15px; border-radius: 12px; margin-top: 20px; }
        input { width: 80%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .btn { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
               border: none; padding: 15px 25px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn:disabled { opacity: 0.5; }
        .error { color: #d9534f; font-weight: bold; }
        .loading { color: var(--tg-theme-hint-color); }
    </style>
</head>
<body>

    <div id="user-info" style="margin-bottom: 15px; font-weight: bold;"></div>
    
    <div id="reader"></div>

    <button id="scan-btn" class="btn" onclick="startScanner()">1. –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>

    <div id="item-details" class="info-card">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞</div>

    <div id="input-area" style="display: none;">
        <input type="number" id="quantity" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" inputmode="numeric">
        <button id="upload-btn" class="btn" onclick="upload()">2. –í—ã–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>

<script>
const tg = window.Telegram.WebApp;
const SCRIPT_URL = 'https://script.google.com';

let html5QrCode;
let currentBarcode = null;
let itemName = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
tg.ready();
tg.expand();
tg.enableClosingConfirmation();

if (tg.initDataUnsafe.user) {
    document.getElementById('user-info').innerText = `–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${tg.initDataUnsafe.user.first_name}`;
}

async function startScanner() {
    const btn = document.getElementById('scan-btn');
    btn.disabled = true;
    btn.innerText = "–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...";

    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
    }
    
    const config = { 
        fps: 20, 
        qrbox: { width: 280, height: 160 },
        aspectRatio: 1.0 // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
    };

    try {
        await html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText) => {
                tg.HapticFeedback.impactOccurred('medium'); 
                currentBarcode = decodedText;
                processBarcode(decodedText);
                stopScanner();
            }
        );
        btn.style.display = 'none';
    } catch (err) {
        tg.showAlert("–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.");
        btn.disabled = false;
        btn.innerText = "1. –í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä";
    }
}

async function stopScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        await html5QrCode.stop();
        document.getElementById('scan-btn').style.display = 'block';
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('scan-btn').innerText = "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π";
    }
}

async function processBarcode(barcode) {
    const details = document.getElementById('item-details');
    details.innerHTML = `<span class="loading">–ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ: ${barcode}...</span>`;
    
    try {
        const response = await fetch(`${SCRIPT_URL}?barcode=${barcode}&t=${Date.now()}`);
        const data = await response.json();

        if (data.success) {
            itemName = data.name;
            details.innerHTML = `‚úÖ <b>–¢–æ–≤–∞—Ä:</b> ${data.name}<br>üì¶ <b>–ö–æ–¥:</b> ${barcode}`;
            document.getElementById('input-area').style.display = 'block';
            tg.HapticFeedback.notificationOccurred('success');
        } else {
            details.innerHTML = `<span class="error">‚ùå –ö–æ–¥ ${barcode} –Ω–µ –Ω–∞–π–¥–µ–Ω</span>`;
            tg.HapticFeedback.notificationOccurred('error');
        }
    } catch (e) {
        details.innerHTML = `<span class="error">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.</span>`;
    }
}

async function upload() {
    const qty = document.getElementById('quantity').value;
    if (!qty || qty <= 0) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");

    const btn = document.getElementById('upload-btn');
    btn.disabled = true;
    btn.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

    const payload = {
        barcode: currentBarcode,
        name: itemName,
        quantity: qty,
        user: tg.initDataUnsafe.user?.username || tg.initDataUnsafe.user?.first_name || 'unknown'
    };

    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º POST —Å —Ç–∏–ø–æ–º text/plain –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å CORS –≤ Google Scripts
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        tg.HapticFeedback.notificationOccurred('success');
        tg.showAlert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!", () => {
            location.reload(); 
        });
    } catch (e) {
        tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: " + e.message);
        btn.disabled = false;
        btn.innerText = "2. –í—ã–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ";
    }
}
</script>
</body>
</html>
