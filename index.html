const tg = window.Telegram.WebApp;
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxiaPpNkx8A3OSEr10dfn-cFlN7TSsm0qABMysrhgDLEON8KA1QDnwqsOqt54_SqdT5YA/exec';

let html5QrCode;
let currentBarcode = null;
let itemName = null;

tg.ready();
tg.expand(); // Разворачиваем на весь экран

if (tg.initDataUnsafe.user) {
    document.getElementById('user-info').innerText = `Сотрудник: ${tg.initDataUnsafe.user.first_name}`;
}

async function startScanner() {
    const btn = document.getElementById('scan-btn');
    btn.disabled = true;
    btn.innerText = "Запуск камеры...";

    // Создаем объект только если его нет
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
    }
    
    const config = { 
        fps: 20, // Увеличиваем частоту кадров для быстрого захвата
        qrbox: { width: 280, height: 160 },
        // Явно указываем, что ищем только EAN-13 для точности
        formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13 ]
    };

    try {
        await html5QrCode.start(
            { facingMode: "environment" }, // Убираем exact для совместимости
            config,
            (decodedText) => {
                currentBarcode = decodedText;
                processBarcode(decodedText);
                stopScanner();
            }
        );
        btn.style.display = 'none';
    } catch (err) {
        console.error(err);
        alert("Ошибка: Убедитесь, что дали доступ к камере в настройках Telegram");
        btn.disabled = false;
        btn.innerText = "1. Включить сканер";
    }
}

async function stopScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        await html5QrCode.stop();
        document.getElementById('scan-btn').style.display = 'block';
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('scan-btn').innerText = "Сканировать еще раз";
    }
}

async function processBarcode(barcode) {
    const details = document.getElementById('item-details');
    details.innerHTML = `<span class="loading">Поиск в базе: ${barcode}...</span>`;
    
    try {
        // Добавляем timestamp чтобы избежать кэширования запроса
        const response = await fetch(`${SCRIPT_URL}?barcode=${barcode}&t=${Date.now()}`);
        const data = await response.json();

        if (data.success) {
            itemName = data.name;
            details.innerHTML = `<b>Товар:</b> ${data.name}<br><b>Код:</b> ${barcode}`;
            document.getElementById('quantity').style.display = 'block';
            document.getElementById('upload-btn').style.display = 'block';
            tg.HapticFeedback.notificationOccurred('success'); // Виброотклик
        } else {
            details.innerHTML = `<span class="error">Код ${barcode} не найден</span>`;
            tg.HapticFeedback.notificationOccurred('error');
        }
    } catch (e) {
        details.innerHTML = `<span class="error">Ошибка связи. Проверьте интернет.</span>`;
    }
}

async function upload() {
    const qty = document.getElementById('quantity').value;
    if (!qty || qty <= 0) return alert("Введите корректное количество");

    const btn = document.getElementById('upload-btn');
    btn.disabled = true;
    btn.innerText = "Отправка...";

    const payload = {
        barcode: currentBarcode,
        name: itemName,
        quantity: qty,
        user: tg.initDataUnsafe.user?.first_name || 'unknown'
    };

    try {
        // Для Google Apps Script часто лучше использовать GET для записи 
        // или проверьте, что ваш скрипт поддерживает CORS POST.
        // Здесь используем метод 'no-cors', если скрипт просто записывает данные.
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            cache: 'no-cache',
            body: JSON.stringify(payload)
        });

        alert("Успешно выгружено!");
        location.reload(); 
    } catch (e) {
        alert("Ошибка при отправке: " + e.message);
        btn.disabled = false;
        btn.innerText = "2. Выгрузить данные";
    }
}
