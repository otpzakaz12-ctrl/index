<!DOCTYPE html>
<html>
<head>
    <script src="https://telegram.org"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        input, button { padding: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <div id="user-info"></div>
    <button onclick="scan()">1. Сканировать штрих-код</button>
    <div id="item-details"></div>
    <input type="number" id="quantity" placeholder="Введите количество" style="display:none">
    <button id="upload-btn" onclick="upload()" style="display:none">2. Выгрузить</button>

    <script>
        const tg = window.Telegram.WebApp;
        const SCRIPT_URL = 'ВАШ_URL_ИЗ_ШАГА_1';
        let currentItem = null;
        let currentBarcode = null;

        tg.ready();
        document.getElementById('user-info').innerText = `Пользователь: ${tg.initDataUnsafe.user?.first_name}`;

        function scan() {
            tg.showScanQrPopup({ text: "Сканируйте штрих-код товара" }, (result) => {
                currentBarcode = result;
                fetch(`${SCRIPT_URL}?barcode=${result}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            currentItem = data;
                            document.getElementById('item-details').innerText = `Товар: ${data.name}`;
                            document.getElementById('quantity').style.display = 'block';
                            document.getElementById('upload-btn').style.display = 'block';
                        } else {
                            alert("Товар не найден");
                        }
                    });
                return true; 
            });
        }

        function upload() {
            const qty = document.getElementById('quantity').value;
            const payload = {
                userName: tg.initDataUnsafe.user?.first_name || "Unknown",
                barcode: currentBarcode,
                itemName: currentItem.name,
                quantity: qty
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(() => {
                tg.showAlert("Файл создан на Google Диске!");
                tg.close();
            });
        }
    </script>
</body>
</html>
