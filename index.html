<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Сканер EAN‑13</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
        }
        input, button {
            padding: 12px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        button {
            background-color: #0088cc;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #006699;
        }
        #item-details {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .error {
            color: red;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="user-info"></div>
    <button onclick="scan()">1. Сканировать штрих‑код EAN‑13</button>
    <div id="item-details"></div>
    <input type="number" id="quantity" placeholder="Введите количество" min="1" style="display:none;">
    <button id="upload-btn" onclick="upload()" style="display:none;">2. Выгрузить</button>
    <div id="status-message" class="error" style="display:none;"></div>

    <script>
        const tg = window.Telegram.WebApp;
        // Ваш URL Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxiaPpNkx8A3OSEr10dfn-cFlN7TSsm0qABMysrhgDLEON8KA1QDnwqsOqt54_SqdT5YA/exec';
        let currentItem = null;
        let currentBarcode = null;

        tg.ready();

        // Отображение имени пользователя
        const userInfo = document.getElementById('user-info');
        if (tg.initDataUnsafe.user) {
            userInfo.innerText = `Пользователь: ${tg.initDataUnsafe.user.first_name || 'Неизвестно'}`;
        } else {
            userInfo.innerText = 'Пользователь не определён';
        }

        function scan() {
            tg.showScanQrPopup(
                { text: 'Отсканируйте штрих‑код EAN‑13 товара' },
                (result) => {
                    if (!result) {
                        alert('Сканирование отменено или не удалось распознать штрих‑код');
                        return false;
                    }

                    // Валидация формата EAN‑13 (13 цифр)
                    const eanRegex = /^\d{13}$/;
                    if (!eanRegex.test(result)) {
                        const statusMessage = document.getElementById('status-message');
                        statusMessage.style.display = 'block';
                        statusMessage.textContent = 'Некорректный штрих‑код: ожидается 13 цифр (EAN‑13)';
                        return false;
                    }

                    currentBarcode = result;
                    const statusMessage = document.getElementById('status-message');

                    // Скрываем сообщение об ошибке
                    statusMessage.style.display = 'none';
                    statusMessage.textContent = '';

                    fetch(`${SCRIPT_URL}?barcode=${result}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Ошибка HTTP: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.name) {
                                currentItem = data;
                                document.getElementById('item-details').innerText = `Товар: ${data.name}`;
                                document.getElementById('quantity').style.display = 'block';
                                document.getElementById('upload-btn').style.display = 'block';
                            } else {
                                alert('Товар не найден в базе данных');
                            }
                        })
                        .catch(error => {
                            console.error('Ошибка при получении данных:', error);
                            statusMessage.style.display = 'block';
                            statusMessage.textContent = `Ошибка: ${error.message}`;
                        });

                    return true;
                }
            );
        }

        function upload() {
            const qtyInput = document.getElementById('quantity');
            const qty = qtyInput.value;
            const statusMessage = document.getElementById('status-message');

            // Скрываем предыдущее сообщение
            statusMessage.style.display = 'none';
            statusMessage.textContent = '';

            if (!qty || parseInt(qty) <= 0) {
                statusMessage.style.display = 'block';
                statusMessage.textContent = 'Пожалуйста, введите корректное количество (больше 0)';
                qtyInput.focus();
                return;
            }

            const payload = {
                userName: tg.initDataUnsafe.user?.first_name || 'Unknown',
                barcode: currentBarcode,
                itemName: currentItem.name,
                quantity: parseInt(qty, 10)
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (response.ok) {
                    tg.showAlert('Данные успешно отправлены!');
                    tg.close();
                } else {
                    throw new Error(`Ошибка сервера: ${response.status}`);
                }
            })
            .catch(error => {
                console.error('Ошибка при отправке данных:', error);
                statusMessage.style.display = 'block';
                statusMessage.textContent = `Отправка не удалась: ${error.message}`;
            });
        }
    </script>
</body>
</html>
